<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Chatbot OLIG3D</title>

    <link rel="stylesheet" href="/styles.css" />

    <style>
        :root {
            --bg1: #06122a;
            --bg2: #050814;
            --glass: rgba(255, 255, 255, 0.06);
            --glass2: rgba(255, 255, 255, 0.04);
            --stroke: rgba(255, 255, 255, 0.08);
            --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.62);
            --muted2: rgba(255, 255, 255, 0.45);
            --blue: #2f6bff;
            --blue2: #1e4ed8;
            --shadow: 0 20px 70px rgba(0, 0, 0, 0.55);
            --radius: 22px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background:
                radial-gradient(1200px 700px at 50% -150px, rgba(60, 120, 255, .35), transparent 60%),
                radial-gradient(900px 600px at 10% 110%, rgba(180, 60, 255, .18), transparent 55%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
            overflow: hidden;
        }

        .page {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 28px 22px;
            gap: 18px;
        }

        .title {
            text-align: center;
            font-weight: 800;
            letter-spacing: .5px;
            font-size: clamp(30px, 3.5vw, 54px);
            margin: 0;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 10px 40px rgba(0, 0, 0, .35);
        }

        .main {
            flex: 1;
            min-height: 0;
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 18px;
            width: min(1320px, 100%);
            margin: 0 auto;
        }

        .card {
            background: var(--glass);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
        }

        /* LEFT PANEL */
        .summary {
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            min-height: 0;
            overflow-y: auto;
        }

        .summary h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
        }

        .totalBox {
            background: var(--glass2);
            border: 1px solid var(--stroke);
            border-radius: 18px;
            padding: 16px;
            text-align: center;
        }

        .totalLabel {
            font-size: 12px;
            color: var(--muted2);
            letter-spacing: .8px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .totalValue {
            font-size: 36px;
            font-weight: 900;
            letter-spacing: .5px;
            line-height: 1;
            margin-bottom: 6px;
        }

        .jobLine {
            font-size: 12px;
            color: var(--muted);
        }

        .rows {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 6px 2px 0;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 10px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .row .k {
            color: var(--muted);
            font-size: 13px;
        }

        .row .v {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            font-weight: 600;
            text-align: right;
            max-width: 55%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .subTitle {
            margin-top: 2px;
            font-size: 12px;
            color: var(--muted2);
            letter-spacing: .8px;
            text-transform: uppercase;
        }

        /* CHAT */
        .chat {
            padding: 18px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chatTop {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 12px;
        }

        .chatHint {
            font-size: 12px;
            color: var(--muted);
        }

        .session {
            font-size: 12px;
            color: var(--muted2);
            white-space: nowrap;
        }

        .session code {
            color: rgba(255, 255, 255, 0.85);
            background: rgba(0, 0, 0, 0.25);
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* MESSAGES */
        #messages {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 6px 6px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.18) transparent;
        }

        #messages::-webkit-scrollbar {
            width: 10px;
        }

        #messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.14);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .msg {
            max-width: 72%;
            padding: 12px 14px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.07);
            background: rgba(255, 255, 255, 0.04);
            color: rgba(255, 255, 255, 0.92);
            line-height: 1.35;
            font-size: 13.5px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .msg.bot {
            align-self: flex-start;
            border-top-left-radius: 8px;
        }

        .msg.user {
            align-self: flex-end;
            background: linear-gradient(180deg, rgba(47, 107, 255, 0.32), rgba(47, 107, 255, 0.18));
            border: 1px solid rgba(47, 107, 255, 0.35);
            border-top-right-radius: 8px;
        }

        .tag {
            display: block;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.55);
            margin-bottom: 6px;
            letter-spacing: .5px;
        }

        /* COMPOSER */
        .composer {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            padding: 12px;
        }

        .attachRow {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(0, 0, 0, 0.18);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 700;
            letter-spacing: .3px;
        }

        .label {
            font-size: 12px;
            color: var(--muted);
            margin-left: 2px;
        }

        select,
        input[type="text"] {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(0, 0, 0, 0.22);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 12px;
            padding: 9px 10px;
            outline: none;
        }

        select {
            padding: 8px 10px;
        }

        .fileWrap {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 240px;
        }

        .fileBtn {
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.06);
            cursor: pointer;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.85);
            user-select: none;
            white-space: nowrap;
        }

        .fileBtn input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .fileName {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.65);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 120px;
        }

        .inputRow {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            height: 44px;
            border-radius: 14px;
        }

        #sendBtn {
            height: 44px;
            padding: 0 18px;
            border-radius: 14px;
            border: 1px solid rgba(47, 107, 255, 0.45);
            background: linear-gradient(180deg, rgba(47, 107, 255, 1), rgba(30, 78, 216, 1));
            color: white;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(47, 107, 255, 0.25);
        }

        #sendBtn:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        .newChat {
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.55);
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px 0 0;
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        @media (max-width: 980px) {
            body {
                overflow: auto;
            }

            .main {
                grid-template-columns: 1fr;
            }

            .summary {
                order: 2;
                max-height: 500px;
            }

            .chat {
                order: 1;
                min-height: 70vh;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <h1 class="title">Chatbot OLIG3D</h1>

        <div class="main">
            <aside class="card summary" id="summaryPanel">
                <h3>Wycena STL</h3>

                <div class="totalBox">
                    <div class="totalLabel">CAŁKOWITY KOSZT</div>
                    <div class="totalValue"><span id="sumTotal">0.00</span> <span id="sumCurrency">PLN</span></div>
                    <div class="jobLine">JOB <span id="sumJob">—</span></div>
                </div>

                <div class="rows">
                    <div class="row">
                        <div class="k">Materiał</div>
                        <div class="v" id="sumMaterial">—</div>
                    </div>
                    <div class="row">
                        <div class="k">Waga</div>
                        <div class="v" id="sumWeight">—</div>
                    </div>
                    <div class="row">
                        <div class="k">Czas</div>
                        <div class="v" id="sumTime">—</div>
                    </div>
                    <div class="row">
                        <div class="k">Wymiary</div>
                        <div class="v" id="sumDims">—</div>
                    </div>
                    <div class="row">
                        <div class="k">Objętość</div>
                        <div class="v" id="sumVolume">—</div>
                    </div>
                </div>

                <div class="subTitle">Składowe ceny</div>
                <div class="rows">
                    <div class="row">
                        <div class="k">Materiał</div>
                        <div class="v" id="sumMatCost">0.00 PLN</div>
                    </div>
                    <div class="row">
                        <div class="k">Czas pracy maszyny</div>
                        <div class="v" id="sumTimeCost">0.00 PLN</div>
                    </div>
                    <div class="row">
                        <div class="k">Energia</div>
                        <div class="v" id="sumEnergyCost">0.00 PLN</div>
                    </div>
                    <div class="row">
                        <div class="k">Marża i obsługa</div>
                        <div class="v" id="sumMargin">0.00 PLN</div>
                    </div>
                </div>
            </aside>

            <section class="card chat">
                <div class="chatTop">
                    <div class="chatHint">OLIG3D: Napisz wiadomość lub wybierz STL i kliknij „Wyślij”.</div>
                    <div class="session">Sesja: <code id="sessionIdText">—</code></div>
                </div>

                <div id="messages"></div>

                <form class="composer" id="chat-form">
                    <div class="attachRow">
                        <span class="pill">STL</span>
                        <span class="label">Materiał</span>

                        <select id="materialSelect">
                            <option value="PLA">PLA</option>
                            <option value="PETG">PETG</option>
                            <option value="ABS">ABS</option>
                            <option value="TPU">TPU</option>
                        </select>

                        <div class="fileWrap">
                            <label class="fileBtn">
                                Wybierz plik
                                <input id="stlFile" type="file" accept=".stl,.STL" />
                            </label>
                            <div class="fileName" id="fileName">Nie wybrano pliku</div>
                        </div>
                    </div>

                    <div class="inputRow">
                        <input id="messageInput" type="text" placeholder="Napisz wiadomość..." autocomplete="off" />
                        <button id="sendBtn" type="submit">Wyślij</button>
                    </div>

                    <button class="newChat" id="newChatBtn" type="button">Zacznij nową rozmowę</button>
                </form>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // ====== CONFIG ======
        const API_CHAT = "/api/chat";
        const API_QUOTE_FROM_STL = "/api/quote-from-stl";
        const API_GET_QUOTE = "/api/quote";

        // ====== STATE ======
        let sessionId = localStorage.getItem("olig3d_sessionId") || "";
        let isBusy = false;

        // ====== ELEMENTS ======
        const sessionIdText = document.getElementById("sessionIdText");
        const messagesEl = document.getElementById("messages");
        const formEl = document.getElementById("chat-form");
        const sendBtn = document.getElementById("sendBtn");
        const messageInput = document.getElementById("messageInput");
        const newChatBtn = document.getElementById("newChatBtn");

        const fileInput = document.getElementById("stlFile");
        const fileNameEl = document.getElementById("fileName");
        const materialSelect = document.getElementById("materialSelect");

        // Summary fields
        const sumTotal = document.getElementById("sumTotal");
        const sumCurrency = document.getElementById("sumCurrency");
        const sumJob = document.getElementById("sumJob");
        const sumMaterial = document.getElementById("sumMaterial");
        const sumWeight = document.getElementById("sumWeight");
        const sumTime = document.getElementById("sumTime");
        const sumDims = document.getElementById("sumDims");
        const sumVolume = document.getElementById("sumVolume");

        const sumMatCost = document.getElementById("sumMatCost");
        const sumTimeCost = document.getElementById("sumTimeCost");
        const sumEnergyCost = document.getElementById("sumEnergyCost");
        const sumMargin = document.getElementById("sumMargin");

        // ====== HELPERS ======
        function setBusy(v) {
            isBusy = v;
            sendBtn.disabled = v;
            messageInput.disabled = v;
            fileInput.disabled = v;
            materialSelect.disabled = v;
        }

        function scrollToBottom() {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function appendMessage(role, text) {
            const div = document.createElement("div");
            div.className = "msg " + (role === "user" ? "user" : "bot");

            const tag = document.createElement("span");
            tag.className = "tag";
            tag.textContent = role === "user" ? "Ty:" : "OLIG3D:";
            div.appendChild(tag);

            const body = document.createElement("div");
            body.textContent = text;
            div.appendChild(body);

            messagesEl.appendChild(div);
            scrollToBottom();
        }

        function fmt2(n) {
            const x = Number(n);
            if (!Number.isFinite(x)) return null;
            return x.toFixed(2);
        }

        function safeText(v, fallback = "—") {
            if (v === null || v === undefined) return fallback;
            if (typeof v === "string" && v.trim() === "") return fallback;
            return String(v);
        }

        function jobFromText(text) {
            const m = String(text || "").match(/JOB-\d{3,6}/i);
            return m ? m[0].toUpperCase() : null;
        }

        function minutesToHHMMSS(minutes) {
            const m = Math.max(0, Math.floor(Number(minutes) || 0));
            const h = Math.floor(m / 60);
            const mm = String(m % 60).padStart(2, "0");
            const ss = String(Math.floor((Number(minutes) * 60) % 60)).padStart(2, "0");
            return `${String(h).padStart(2, "0")}:${mm}:${ss}`;
        }

        function fmtDims(d) {
            if (!d) return "—";
            // Obsługa obiektu geometry z Pythona {x, y, z}
            if (typeof d === "object" && !Array.isArray(d)) {
                const x = d.x ?? d.width ?? d.w;
                const y = d.y ?? d.depth ?? d.d;
                const z = d.z ?? d.height ?? d.h;
                if (x != null && y != null && z != null) {
                    return `${Number(x).toFixed(1)}×${Number(y).toFixed(1)}×${Number(z).toFixed(1)} mm`;
                }
            }
            // Obsługa tablicy
            if (Array.isArray(d) && d.length >= 3) {
                return `${Number(d[0]).toFixed(1)}×${Number(d[1]).toFixed(1)}×${Number(d[2]).toFixed(1)} mm`;
            }
            // Obsługa stringa
            return safeText(d);
        }

        /**
         * Normalizuje dane z różnych endpointów (chat, stl, get quote).
         * Obsługuje różne struktury zagnieżdżenia JSON z n8n.
         */
        function normalizeQuotePayload(data) {
            let root = {};
            let geometry = null;

            // 1. CHAT (/api/chat) -> server zwraca { raw: { quote: {...} } } lub n8n zwraca quote wewnątrz
            if (data.raw && data.raw.quote) {
                root = data.raw.quote;
            }
            // 2. STL UPLOAD (/api/quote-from-stl) -> server zwraca { quote: { success:true, quote: {...} }, geometry: {...} }
            else if (data.quote && data.quote.quote) {
                root = data.quote.quote;
                geometry = data.geometry || null;
            }
            // 3. GET QUOTE (/api/quote/:id) -> server zwraca płaską strukturę lub { json: ... }
            else if (data.jobExtId || data.job_id) {
                root = data;
            }
            // Fallback
            else if (data.quote) {
                root = data.quote;
            }

            // Wydobycie 'breakdown' - n8n zwraca różne nazwy kluczy w różnych workflowach
            const bd = root.breakdown || {};

            // Mapowanie:
            // Chat: materialCost, timeCost, energyCost
            // STL: costMat, costTime, costEnergy
            const breakdown = {
                mat: bd.materialCost ?? bd.costMat ?? 0,
                time: bd.timeCost ?? bd.costTime ?? 0,
                nrg: bd.energyCost ?? bd.costEnergy ?? 0,
                margin: bd.margin ?? 0
            };

            // Wymiary - priorytet dla geometrii z Pythona, potem string z bazy
            const dims = geometry?.dimensions_mm || root.dimensions || root.dimensions_str || null;
            const volume = geometry?.volume_cm3 || root.volume || root.volume_cm3 || null;

            // Czas
            const timeMin = root.time?.minutes ?? root.estimated_time_min ?? root.time_min ?? 0;
            const timeStr = root.time?.hhmmss ?? root.time_hhmmss ?? minutesToHHMMSS(timeMin);

            // Materiał
            const matType = root.material?.material ?? root.material?.type ?? root.material ?? "—";
            const weight = root.material?.grams ?? root.estimated_weight_g ?? root.weight_g ?? 0;

            return {
                total: root.total ?? 0,
                currency: root.currency || "PLN",
                jobExtId: root.jobExtId || root.ext_id || root.new_job_ext_id || "—",

                materialType: matType,
                weightG: weight,

                timeString: timeStr,
                dims: dims,
                volume: volume,

                breakdown: breakdown
            };
        }

        function setSummaryFromAny(payload) {
            const q = normalizeQuotePayload(payload);

            // Główne KPI
            sumTotal.textContent = fmt2(q.total) ?? "0.00";
            sumCurrency.textContent = q.currency;

            // Job ID
            const jobTxt = safeText(q.jobExtId);
            sumJob.textContent = jobTxt.includes("JOB") ? jobTxt : "JOB-" + jobTxt;

            // Parametry fizyczne
            sumMaterial.textContent = safeText(q.materialType);
            sumWeight.textContent = (q.weightG > 0) ? `${fmt2(q.weightG)} g` : "—";
            sumTime.textContent = q.timeString !== "00:00:00" ? q.timeString : "—";
            sumDims.textContent = fmtDims(q.dims);
            sumVolume.textContent = (q.volume > 0) ? `${fmt2(q.volume)} cm³` : "—";

            // Rozbicie kosztów
            const cur = q.currency;
            sumMatCost.textContent = `${fmt2(q.breakdown.mat)} ${cur}`;
            sumTimeCost.textContent = `${fmt2(q.breakdown.time)} ${cur}`;
            sumEnergyCost.textContent = `${fmt2(q.breakdown.nrg)} ${cur}`;
            sumMargin.textContent = `${fmt2(q.breakdown.margin)} ${cur}`;
        }

        function resetSummary() {
            sumTotal.textContent = "0.00";
            sumCurrency.textContent = "PLN";
            sumJob.textContent = "—";
            sumMaterial.textContent = "—";
            sumWeight.textContent = "—";
            sumTime.textContent = "—";
            sumDims.textContent = "—";
            sumVolume.textContent = "—";
            sumMatCost.textContent = "0.00 PLN";
            sumTimeCost.textContent = "0.00 PLN";
            sumEnergyCost.textContent = "0.00 PLN";
            sumMargin.textContent = "0.00 PLN";
        }

        function setSession(id) {
            sessionId = id || "";
            sessionIdText.textContent = sessionId || "—";
            if (sessionId) localStorage.setItem("olig3d_sessionId", sessionId);
            else localStorage.removeItem("olig3d_sessionId");
        }

        async function safeReadJson(res) {
            const ct = (res.headers.get("content-type") || "").toLowerCase();
            if (ct.includes("application/json")) return await res.json();
            const txt = await res.text();
            return { success: false, error: "NON_JSON", preview: txt.slice(0, 180) };
        }

        function clearFile() {
            fileInput.value = "";
            fileNameEl.textContent = "Nie wybrano pliku";
        }

        // ====== ACTIONS ======
        async function sendChatMessage(text) {
            const userText = String(text || "").trim();
            if (!userText) return;

            appendMessage("user", userText);

            setBusy(true);
            try {
                const payload = {
                    message: userText,
                    sessionId: sessionId || undefined,
                    source: "web-3d.olig.site"
                };

                const res = await axios.post(API_CHAT, payload, { timeout: 45000 });
                const data = res?.data || {};

                if (data.sessionId) setSession(data.sessionId);

                // Sprawdzamy, czy w odpowiedzi czatu jest wycena (zagnieżdżona w raw)
                const hasQuote = data.raw && data.raw.quote;

                if (hasQuote) {
                    setSummaryFromAny(data);
                } else {
                    // Fallback: Jeśli user wpisał JOB-xxxx, a n8n nie zwróciło quote wprost,
                    // spróbujmy pobrać wycenę ręcznie z endpointu GET /api/quote
                    const job = jobFromText(userText);
                    if (job) {
                        try {
                            const r2 = await fetch(`${API_GET_QUOTE}/${encodeURIComponent(job)}`);
                            const d2 = await safeReadJson(r2);
                            // API GET zwraca dane wprost lub w wrapperze
                            if (d2 && (d2.success || d2.jobExtId)) {
                                setSummaryFromAny(d2);
                            }
                        } catch (e) {
                            console.warn("Nie udało się pobrać wyceny w tle:", e);
                        }
                    }
                }

                let reply = (data.reply && String(data.reply).trim()) ? String(data.reply).trim() : "";
                if (!reply) {
                    reply = hasQuote
                        ? "Wyniki wyświetliłem po lewej w panelu „Wycena STL”."
                        : "OK.";
                }
                appendMessage("bot", reply);

            } catch (err) {
                console.error(err);
                appendMessage("bot", "Błąd połączenia z serwerem.");
            } finally {
                setBusy(false);
                messageInput.value = "";
                clearFile();
            }
        }

        async function sendStlQuote(file, material) {
            appendMessage("user", `Wysyłam STL: ${file.name}\nMateriał: ${material}`);

            setBusy(true);
            try {
                const fd = new FormData();
                fd.append("model", file);
                fd.append("material", material);

                const res = await fetch(API_QUOTE_FROM_STL, { method: "POST", body: fd });
                const data = await safeReadJson(res);

                if (!data || data.success === false) {
                    const errInfo = data.details || data.error || "Nieznany błąd";
                    appendMessage("bot", `Błąd wyceny STL: ${errInfo}`);
                    return;
                }

                // Aktualizacja panelu po lewej
                // Endpoint zwraca { quote: { ...n8n_response... }, geometry: {...} }
                setSummaryFromAny(data);

                appendMessage("bot", "Wyniki wyświetliłem po lewej w panelu „Wycena STL”.");

            } catch (e) {
                console.error(e);
                appendMessage("bot", "Błąd połączenia z serwerem przy wycenie STL.");
            } finally {
                setBusy(false);
                clearFile();
                messageInput.value = "";
            }
        }

        // ====== EVENTS ======
        fileInput.addEventListener("change", () => {
            const f = fileInput.files && fileInput.files[0];
            fileNameEl.textContent = f ? f.name : "Nie wybrano pliku";
        });

        formEl.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (isBusy) return;

            const f = fileInput.files && fileInput.files[0];

            if (f) {
                const mat = materialSelect.value || "PLA";
                await sendStlQuote(f, mat);
                return;
            }

            await sendChatMessage(messageInput.value);
        });

        newChatBtn.addEventListener("click", () => {
            setSession("");
            messagesEl.innerHTML = "";
            resetSummary();
            clearFile();
            messageInput.value = "";
            appendMessage("bot", "Nowa rozmowa. Wpisz np. JOB-0050.");
        });

        // ====== INIT ======
        setSession(sessionId);
        resetSummary();
        appendMessage("bot", "Cześć! Napisz wiadomość lub wybierz STL i kliknij „Wyślij”.");
    </script>
</body>

</html>