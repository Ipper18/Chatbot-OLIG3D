<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1.0" />
    <title>Chatbot OLIG3D</title>

    <!-- Jeśli masz globalne style, zostaw -->
    <link rel="stylesheet" href="/styles.css" />

    <style>
        :root {
            --bg1: #06122a;
            --bg2: #050814;
            --glass: rgba(255, 255, 255, 0.06);
            --glass2: rgba(255, 255, 255, 0.04);
            --stroke: rgba(255, 255, 255, 0.08);
            --text: rgba(255, 255, 255, 0.92);
            --muted: rgba(255, 255, 255, 0.62);
            --muted2: rgba(255, 255, 255, 0.45);
            --blue: #2f6bff;
            --blue2: #1e4ed8;
            --shadow: 0 20px 70px rgba(0, 0, 0, 0.55);
            --radius: 22px;
        }

        * {
            box-sizing: border-box;
        }

        html,
        body {
            height: 100%;
        }

        body {
            margin: 0;
            color: var(--text);
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            background:
                radial-gradient(1200px 700px at 50% -150px, rgba(60, 120, 255, .35), transparent 60%),
                radial-gradient(900px 600px at 10% 110%, rgba(180, 60, 255, .18), transparent 55%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
            overflow: hidden;
            /* klucz: strona nie rośnie, tylko scroll w chacie */
        }

        .page {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 28px 22px;
            gap: 18px;
        }

        .title {
            text-align: center;
            font-weight: 800;
            letter-spacing: .5px;
            font-size: clamp(30px, 3.5vw, 54px);
            margin: 0;
            color: rgba(255, 255, 255, 0.95);
            text-shadow: 0 10px 40px rgba(0, 0, 0, .35);
        }

        .main {
            flex: 1;
            min-height: 0;
            /* wymagane żeby scroll działał poprawnie w flex */
            display: grid;
            grid-template-columns: 320px 1fr;
            gap: 18px;
            width: min(1320px, 100%);
            margin: 0 auto;
        }

        .card {
            background: var(--glass);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(14px);
            -webkit-backdrop-filter: blur(14px);
        }

        /* LEFT PANEL */
        .summary {
            padding: 18px;
            display: flex;
            flex-direction: column;
            gap: 14px;
            min-height: 0;
        }

        .summary h3 {
            margin: 0;
            font-size: 16px;
            font-weight: 700;
            color: rgba(255, 255, 255, 0.9);
        }

        .totalBox {
            background: var(--glass2);
            border: 1px solid var(--stroke);
            border-radius: 18px;
            padding: 16px;
            text-align: center;
        }

        .totalLabel {
            font-size: 12px;
            color: var(--muted2);
            letter-spacing: .8px;
            text-transform: uppercase;
            margin-bottom: 8px;
        }

        .totalValue {
            font-size: 36px;
            font-weight: 900;
            letter-spacing: .5px;
            line-height: 1;
            margin-bottom: 6px;
        }

        .jobLine {
            font-size: 12px;
            color: var(--muted);
        }

        .rows {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding: 6px 2px 0;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 10px;
            border-radius: 14px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
        }

        .row .k {
            color: var(--muted);
            font-size: 13px;
        }

        .row .v {
            color: rgba(255, 255, 255, 0.9);
            font-size: 13px;
            font-weight: 600;
            text-align: right;
            max-width: 55%;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .subTitle {
            margin-top: 2px;
            font-size: 12px;
            color: var(--muted2);
            letter-spacing: .8px;
            text-transform: uppercase;
        }

        /* CHAT */
        .chat {
            padding: 18px;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .chatTop {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 10px 12px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            margin-bottom: 12px;
        }

        .chatHint {
            font-size: 12px;
            color: var(--muted);
        }

        .session {
            font-size: 12px;
            color: var(--muted2);
            white-space: nowrap;
        }

        .session code {
            color: rgba(255, 255, 255, 0.85);
            background: rgba(0, 0, 0, 0.25);
            padding: 2px 6px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        /* SCROLLABLE MESSAGES */
        #messages {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            padding: 6px 6px 10px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.18) transparent;
        }

        #messages::-webkit-scrollbar {
            width: 10px;
        }

        #messages::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.14);
            border-radius: 10px;
            border: 2px solid transparent;
            background-clip: padding-box;
        }

        .msg {
            max-width: 72%;
            padding: 12px 14px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, 0.07);
            background: rgba(255, 255, 255, 0.04);
            color: rgba(255, 255, 255, 0.92);
            line-height: 1.35;
            font-size: 13.5px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .msg.bot {
            align-self: flex-start;
            border-top-left-radius: 8px;
        }

        .msg.user {
            align-self: flex-end;
            background: linear-gradient(180deg, rgba(47, 107, 255, 0.32), rgba(47, 107, 255, 0.18));
            border: 1px solid rgba(47, 107, 255, 0.35);
            border-top-right-radius: 8px;
        }

        .tag {
            display: block;
            font-size: 10px;
            color: rgba(255, 255, 255, 0.55);
            margin-bottom: 6px;
            letter-spacing: .5px;
        }

        /* COMPOSER */
        .composer {
            margin-top: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            background: rgba(255, 255, 255, 0.03);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 18px;
            padding: 12px;
        }

        .attachRow {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .pill {
            display: inline-flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(0, 0, 0, 0.18);
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 700;
            letter-spacing: .3px;
        }

        .label {
            font-size: 12px;
            color: var(--muted);
            margin-left: 2px;
        }

        select,
        input[type="text"] {
            color: rgba(255, 255, 255, 0.9);
            background: rgba(0, 0, 0, 0.22);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 12px;
            padding: 9px 10px;
            outline: none;
        }

        select {
            padding: 8px 10px;
        }

        .fileWrap {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1;
            min-width: 240px;
        }

        .fileBtn {
            position: relative;
            overflow: hidden;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.12);
            background: rgba(255, 255, 255, 0.06);
            cursor: pointer;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.85);
            user-select: none;
            white-space: nowrap;
        }

        .fileBtn input {
            position: absolute;
            inset: 0;
            opacity: 0;
            cursor: pointer;
        }

        .fileName {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.65);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            flex: 1;
            min-width: 120px;
        }

        .inputRow {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        #messageInput {
            flex: 1;
            height: 44px;
            border-radius: 14px;
        }

        #sendBtn {
            height: 44px;
            padding: 0 18px;
            border-radius: 14px;
            border: 1px solid rgba(47, 107, 255, 0.45);
            background: linear-gradient(180deg, rgba(47, 107, 255, 1), rgba(30, 78, 216, 1));
            color: white;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(47, 107, 255, 0.25);
        }

        #sendBtn:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        .newChat {
            text-align: center;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.55);
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 6px 0 0;
            text-decoration: underline;
            text-underline-offset: 3px;
        }

        @media (max-width: 980px) {
            body {
                overflow: auto;
            }

            .main {
                grid-template-columns: 1fr;
            }

            .summary {
                order: 2;
            }

            .chat {
                order: 1;
                min-height: 70vh;
            }
        }
    </style>
</head>

<body>
    <div class="page">
        <h1 class="title">Chatbot OLIG3D</h1>

        <div class="main">
            <!-- LEFT: SUMMARY -->
            <aside class="card summary" id="summaryPanel">
                <h3>Wycena STL</h3>

                <div class="totalBox">
                    <div class="totalLabel">CAŁKOWITY KOSZT</div>
                    <div class="totalValue"><span id="sumTotal">0.00</span> <span id="sumCurrency">PLN</span></div>
                    <div class="jobLine">JOB <span id="sumJob">—</span></div>
                </div>

                <div class="rows">
                    <div class="row">
                        <div class="k">Materiał</div>
                        <div class="v" id="sumMaterial">—</div>
                    </div>
                    <div class="row">
                        <div class="k">Waga</div>
                        <div class="v" id="sumWeight">—</div>
                    </div>
                    <div class="row">
                        <div class="k">Czas</div>
                        <div class="v" id="sumTime">—</div>
                    </div>
                    <div class="row">
                        <div class="k">Wymiary</div>
                        <div class="v" id="sumDims">—</div>
                    </div>
                    <div class="row">
                        <div class="k">Objętość</div>
                        <div class="v" id="sumVolume">—</div>
                    </div>
                </div>

                <div class="subTitle">Składowe ceny</div>
                <div class="rows">
                    <div class="row">
                        <div class="k">Materiał</div>
                        <div class="v" id="sumMatCost">0.00 PLN</div>
                    </div>
                    <div class="row">
                        <div class="k">Czas pracy maszyny</div>
                        <div class="v" id="sumTimeCost">0.00 PLN</div>
                    </div>
                    <div class="row">
                        <div class="k">Energia</div>
                        <div class="v" id="sumEnergyCost">0.00 PLN</div>
                    </div>
                    <div class="row">
                        <div class="k">Marża i obsługa</div>
                        <div class="v" id="sumMargin">0.00 PLN</div>
                    </div>
                </div>
            </aside>

            <!-- RIGHT: CHAT -->
            <section class="card chat">
                <div class="chatTop">
                    <div class="chatHint">OLIG3D: Napisz wiadomość lub wybierz STL i kliknij „Wyślij”.</div>
                    <div class="session">Sesja: <code id="sessionIdText">—</code></div>
                </div>

                <div id="messages"></div>

                <form class="composer" id="chat-form">
                    <div class="attachRow">
                        <span class="pill">STL</span>
                        <span class="label">Materiał</span>

                        <select id="materialSelect">
                            <option value="PLA">PLA</option>
                            <option value="PETG">PETG</option>
                            <option value="ABS">ABS</option>
                            <option value="TPU">TPU</option>
                        </select>

                        <div class="fileWrap">
                            <label class="fileBtn">
                                Wybierz plik
                                <input id="stlFile" type="file" accept=".stl,.STL" />
                            </label>
                            <div class="fileName" id="fileName">Nie wybrano pliku</div>
                        </div>
                    </div>

                    <div class="inputRow">
                        <input id="messageInput" type="text" placeholder="Napisz wiadomość..." autocomplete="off" />
                        <button id="sendBtn" type="submit">Wyślij</button>
                    </div>

                    <button class="newChat" id="newChatBtn" type="button">Zacznij nową rozmowę</button>
                </form>
            </section>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        // ====== CONFIG ======
        const API_CHAT = "/api/chat";
        const API_QUOTE_FROM_STL = "/api/quote-from-stl";
        const API_GET_QUOTE = "/api/quote"; // fallback: /api/quote/:extId

        // ====== STATE ======
        let sessionId = localStorage.getItem("olig3d_sessionId") || "";
        let isBusy = false;

        // ====== ELEMENTS ======
        const sessionIdText = document.getElementById("sessionIdText");
        const messagesEl = document.getElementById("messages");
        const formEl = document.getElementById("chat-form");
        const sendBtn = document.getElementById("sendBtn");
        const messageInput = document.getElementById("messageInput");
        const newChatBtn = document.getElementById("newChatBtn");

        const fileInput = document.getElementById("stlFile");
        const fileNameEl = document.getElementById("fileName");
        const materialSelect = document.getElementById("materialSelect");

        // Summary fields
        const sumTotal = document.getElementById("sumTotal");
        const sumCurrency = document.getElementById("sumCurrency");
        const sumJob = document.getElementById("sumJob");
        const sumMaterial = document.getElementById("sumMaterial");
        const sumWeight = document.getElementById("sumWeight");
        const sumTime = document.getElementById("sumTime");
        const sumDims = document.getElementById("sumDims");
        const sumVolume = document.getElementById("sumVolume");

        const sumMatCost = document.getElementById("sumMatCost");
        const sumTimeCost = document.getElementById("sumTimeCost");
        const sumEnergyCost = document.getElementById("sumEnergyCost");
        const sumMargin = document.getElementById("sumMargin");

        // ====== HELPERS ======
        function setBusy(v) {
            isBusy = v;
            sendBtn.disabled = v;
            messageInput.disabled = v;
            fileInput.disabled = v;
            materialSelect.disabled = v;
        }

        function scrollToBottom() {
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function appendMessage(role, text) {
            const div = document.createElement("div");
            div.className = "msg " + (role === "user" ? "user" : "bot");

            const tag = document.createElement("span");
            tag.className = "tag";
            tag.textContent = role === "user" ? "Ty:" : "OLIG3D:";
            div.appendChild(tag);

            const body = document.createElement("div");
            body.textContent = text;
            div.appendChild(body);

            messagesEl.appendChild(div);
            scrollToBottom();
        }

        function fmt2(n) {
            const x = Number(n);
            if (!isFinite(x)) return null;
            return x.toFixed(2);
        }

        function safeText(v, fallback = "—") {
            if (v === null || v === undefined) return fallback;
            if (typeof v === "string" && v.trim() === "") return fallback;
            return String(v);
        }

        function jobFromText(text) {
            const m = String(text || "").match(/JOB-\d{3,6}/i);
            return m ? m[0].toUpperCase() : null;
        }

        function normalizeQuotePayload(payload) {
            // payload może być:
            // - { success, reply, quote: {...}, geometry: {...} }
            // - { quote: {...}, geometry: {...} }
            // - bezpośrednio {...quote...}
            const root = payload && payload.quote ? payload.quote : payload;

            const geom = payload && payload.geometry ? payload.geometry : null;

            const jobExtId = root?.jobExtId || root?.ext_id || root?.extId || null;

            const total = root?.total ?? root?.quote_total ?? null;
            const currency = root?.currency || "PLN";

            const materialType =
                root?.material?.type ||
                root?.material?.material ||
                root?.material?.name ||
                (typeof root?.material === "string" ? root.material : null) ||
                null;

            const grams =
                root?.material?.grams ??
                root?.estimated_weight_g ??
                root?.estimated_weight ??
                null;

            const minutes =
                root?.time?.minutes ??
                root?.estimated_time_min ??
                null;

            const hhmmss =
                root?.time?.hhmmss ??
                (minutes != null ? minutesToHHMMSS(minutes) : null);

            const dims =
                geom?.dimensions_mm ||
                root?.dimensions ||
                null;

            const volume =
                geom?.volume_cm3 ||
                root?.volume_cm3 ||
                root?.volume ||
                null;

            const breakdown = root?.breakdown || {
                materialCost: root?.material_cost ?? null,
                timeCost: root?.time_cost ?? null,
                energyCost: root?.energy_cost ?? null,
                margin: root?.margin ?? null
            };

            return {
                jobExtId, total, currency,
                materialType, grams,
                minutes, hhmmss,
                dims, volume,
                breakdown
            };
        }

        function minutesToHHMMSS(minutes) {
            const m = Math.max(0, Math.floor(Number(minutes) || 0));
            const h = Math.floor(m / 60);
            const mm = String(m % 60).padStart(2, "0");
            return String(h).padStart(2, "0") + ":" + mm + ":00";
        }

        function fmtDims(d) {
            if (!d) return "—";
            // może być obiekt: {x:..., y:..., z:...} albo {width,height,depth} albo tablica
            if (Array.isArray(d) && d.length >= 3) {
                return `${Number(d[0]).toFixed(1)}×${Number(d[1]).toFixed(1)}×${Number(d[2]).toFixed(1)} mm`;
            }
            if (typeof d === "object") {
                const x = d.x ?? d.width ?? d.w;
                const y = d.y ?? d.depth ?? d.d;
                const z = d.z ?? d.height ?? d.h;
                if (x != null && y != null && z != null) {
                    return `${Number(x).toFixed(1)}×${Number(y).toFixed(1)}×${Number(z).toFixed(1)} mm`;
                }
            }
            return safeText(d);
        }

        function setSummaryFromAny(payload) {
            const q = normalizeQuotePayload(payload);

            // total
            const t = fmt2(q.total);
            sumTotal.textContent = t !== null ? t : "0.00";
            sumCurrency.textContent = safeText(q.currency, "PLN");

            // job
            sumJob.textContent = safeText(q.jobExtId, "—").replace(/^JOB-?/i, "").includes("-")
                ? safeText(q.jobExtId, "—")
                : safeText(q.jobExtId, "—");

            // material / weight / time / dims / volume
            sumMaterial.textContent = safeText(q.materialType, "—");
            sumWeight.textContent = (q.grams != null && isFinite(Number(q.grams)))
                ? `${Number(q.grams).toFixed(2)} g`
                : "—";

            const timeStr = q.hhmmss ? `${safeText(q.minutes, "—")} min (${q.hhmmss})` : "—";
            sumTime.textContent = timeStr;

            sumDims.textContent = fmtDims(q.dims);

            sumVolume.textContent = (q.volume != null && isFinite(Number(q.volume)))
                ? `${Number(q.volume).toFixed(2)} cm³`
                : "—";

            // breakdown
            const cur = safeText(q.currency, "PLN");
            const mc = fmt2(q.breakdown?.materialCost);
            const tc = fmt2(q.breakdown?.timeCost);
            const ec = fmt2(q.breakdown?.energyCost);
            const mg = fmt2(q.breakdown?.margin);

            sumMatCost.textContent = `${mc !== null ? mc : "0.00"} ${cur}`;
            sumTimeCost.textContent = `${tc !== null ? tc : "0.00"} ${cur}`;
            sumEnergyCost.textContent = `${ec !== null ? ec : "0.00"} ${cur}`;
            sumMargin.textContent = `${mg !== null ? mg : "0.00"} ${cur}`;
        }

        function resetSummary() {
            sumTotal.textContent = "0.00";
            sumCurrency.textContent = "PLN";
            sumJob.textContent = "—";
            sumMaterial.textContent = "—";
            sumWeight.textContent = "—";
            sumTime.textContent = "—";
            sumDims.textContent = "—";
            sumVolume.textContent = "—";
            sumMatCost.textContent = "0.00 PLN";
            sumTimeCost.textContent = "0.00 PLN";
            sumEnergyCost.textContent = "0.00 PLN";
            sumMargin.textContent = "0.00 PLN";
        }

        function setSession(id) {
            sessionId = id || "";
            sessionIdText.textContent = sessionId || "—";
            if (sessionId) localStorage.setItem("olig3d_sessionId", sessionId);
            else localStorage.removeItem("olig3d_sessionId");
        }

        async function safeReadJson(res) {
            const ct = (res.headers.get("content-type") || "").toLowerCase();
            if (ct.includes("application/json")) return await res.json();
            // jak server zwróci HTML (np. MulterError), NIE wpychamy tego do chatu
            const txt = await res.text();
            return { success: false, error: "NON_JSON", status: res.status, preview: txt.slice(0, 180) };
        }

        function clearFile() {
            fileInput.value = "";
            fileNameEl.textContent = "Nie wybrano pliku";
        }

        // ====== ACTIONS ======
        async function sendChatMessage(text) {
            const userText = String(text || "").trim();
            if (!userText) return;

            appendMessage("user", userText);

            setBusy(true);
            try {
                const payload = {
                    message: userText,
                    sessionId: sessionId || undefined,
                    source: "web-3d.olig.site"
                };

                const res = await axios.post(API_CHAT, payload, { timeout: 45000 });
                const data = res?.data || {};

                if (data.sessionId) setSession(data.sessionId);

                // Jeśli przyszła wycena/quote -> aktualizujemy panel po lewej
                if (data.quote) {
                    setSummaryFromAny(data); // bierze data.quote
                } else {
                    // fallback: jeśli user wpisał JOB-xxxx, a workflow nie zwrócił quote
                    const job = jobFromText(userText);
                    if (job) {
                        try {
                            const r2 = await fetch(`${API_GET_QUOTE}/${encodeURIComponent(job.toUpperCase())}`);
                            const d2 = await safeReadJson(r2);
                            if (d2 && d2.quote) setSummaryFromAny(d2);
                        } catch (e) { }
                    }
                }

                // Odpowiedź bota: preferujemy krótką, a jak jej brak to ustawiamy stałą
                let reply = (data.reply && String(data.reply).trim()) ? String(data.reply).trim() : "";
                if (!reply) {
                    reply = data.quote
                        ? "Wyniki wyświetliłem po lewej w panelu „Wycena STL”."
                        : "OK.";
                }
                appendMessage("bot", reply);

            } catch (err) {
                appendMessage("bot", "Błąd połączenia z serwerem.");
            } finally {
                setBusy(false);
                messageInput.value = "";
                // WAŻNE: nie trzymamy pliku “na przyszłość”
                clearFile();
            }
        }

        async function sendStlQuote(file, material) {
            // komunikat usera
            appendMessage("user", `Wysyłam STL: ${file.name}\nMateriał: ${material}`);

            setBusy(true);
            try {
                const fd = new FormData();

                // KLUCZ: server.js ma upload.single('model'), więc musi być 'model'
                fd.append("model", file);

                // server.js oczekuje też 'material'
                fd.append("material", material);

                const res = await fetch(API_QUOTE_FROM_STL, { method: "POST", body: fd });
                const data = await safeReadJson(res);

                if (!data || data.success === false) {
                    appendMessage("bot", "Błąd wyceny STL po stronie serwera.");
                    return;
                }

                // Aktualizacja panelu po lewej (quote + geometry)
                if (data.quote || data.geometry) {
                    setSummaryFromAny(data); // normalizer ogarnia data.quote + data.geometry
                }

                appendMessage("bot", "Wyniki wyświetliłem po lewej w panelu „Wycena STL”.");

            } catch (e) {
                appendMessage("bot", "Błąd połączenia z serwerem przy wycenie STL.");
            } finally {
                setBusy(false);
                clearFile();            // usuwa “przyczepianie” pliku
                messageInput.value = ""; // czyścimy input
            }
        }

        // ====== EVENTS ======
        fileInput.addEventListener("change", () => {
            const f = fileInput.files && fileInput.files[0];
            fileNameEl.textContent = f ? f.name : "Nie wybrano pliku";
        });

        formEl.addEventListener("submit", async (e) => {
            e.preventDefault();
            if (isBusy) return;

            const f = fileInput.files && fileInput.files[0];

            // Jeśli wybrano plik -> robimy wycenę STL (i TYLKO to)
            if (f) {
                const mat = materialSelect.value || "PLA";
                await sendStlQuote(f, mat);
                return;
            }

            // Inaczej -> standardowy chat / JOB-xxxx
            await sendChatMessage(messageInput.value);
        });

        newChatBtn.addEventListener("click", () => {
            // reset sesji + UI
            setSession("");
            messagesEl.innerHTML = "";
            resetSummary();
            clearFile();
            messageInput.value = "";
            appendMessage("bot", "Nowa rozmowa. Wpisz np. JOB-0050.");
        });

        // ====== INIT ======
        setSession(sessionId);
        resetSummary();
        appendMessage("bot", "Cześć! Napisz wiadomość lub wybierz STL i kliknij „Wyślij”.");
    </script>
</body>

</html>