<!doctype html>
<html lang="pl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chatbot OLIG3D</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
        /* awaryjnie gdyby styles.css nie istniał */
        body {
            margin: 0;
            font-family: system-ui, Arial;
            background: #1d1f23;
            color: #fff;
        }

        .wrap {
            max-width: 900px;
            margin: 40px auto;
            padding: 0 16px;
        }

        .card {
            background: #0f1114;
            border-radius: 18px;
            padding: 18px;
            box-shadow: 0 12px 40px rgba(0, 0, 0, .35);
        }

        #messages {
            min-height: 520px;
            max-height: 520px;
            overflow: auto;
            padding: 16px;
            background: #0b0d10;
            border-radius: 16px;
        }

        .row {
            display: flex;
            margin: 10px 0;
        }

        .row.user {
            justify-content: flex-end;
        }

        .bubble {
            max-width: 70%;
            padding: 10px 12px;
            border-radius: 14px;
            background: #2a2f37;
            white-space: pre-wrap;
        }

        .row.user .bubble {
            background: #1e6fff;
        }

        .meta {
            font-size: 12px;
            opacity: .8;
            margin-bottom: 4px;
        }

        .bar {
            display: flex;
            gap: 10px;
            margin-top: 14px;
        }

        #chat-input {
            flex: 1;
            padding: 12px;
            border-radius: 10px;
            border: 1px solid #3b3f46;
            background: #12151a;
            color: #fff;
        }

        button {
            padding: 12px 16px;
            border-radius: 10px;
            border: none;
            background: #1e6fff;
            color: #fff;
            cursor: pointer;
        }

        button:disabled {
            opacity: .6;
            cursor: not-allowed;
        }

        .footer {
            margin-top: 10px;
            text-align: center;
        }

        .footer a {
            color: #9bb7ff;
            text-decoration: underline;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1 style="text-align:center;">Chatbot OLIG3D</h1>

        <div class="card">
            <div id="messages"></div>

            <div class="bar">
                <input id="chat-input" placeholder="Napisz wiadomość..." autocomplete="off" />
                <button id="sendBtn" type="button">Wyślij</button>
                <button id="stlBtn" type="button" title="Wycena STL">STL</button>
                <input id="stlInput" type="file" accept=".stl" style="display:none" />
            </div>

            <div class="footer">
                <a id="resetLink">Zacznij nową rozmowę</a>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <script>
        const SOURCE = 'web-3d.olig.site';
        const SESSION_KEY = 'olig3d_session_id';

        const messagesEl = document.getElementById('messages');
        const inputEl = document.getElementById('chat-input');
        const sendBtn = document.getElementById('sendBtn');
        const resetLink = document.getElementById('resetLink');
        const stlBtn = document.getElementById('stlBtn');
        const stlInput = document.getElementById('stlInput');

        let busy = false;

        function getSessionId() {
            return localStorage.getItem(SESSION_KEY);
        }
        function setSessionId(id) {
            if (id) localStorage.setItem(SESSION_KEY, id);
        }
        function clearSession() {
            localStorage.removeItem(SESSION_KEY);
        }

        function appendMessage(who, text, kind, id) {
            const row = document.createElement('div');
            row.className = 'row ' + (kind || 'bot');
            if (id) row.dataset.id = id;

            const bubble = document.createElement('div');
            bubble.className = 'bubble';

            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = who + ':';

            bubble.appendChild(meta);
            bubble.appendChild(document.createTextNode(text));

            row.appendChild(bubble);
            messagesEl.appendChild(row);
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        function updateMessageById(id, who, text, kind) {
            const row = [...messagesEl.querySelectorAll('.row')].find(r => r.dataset.id === id);
            if (!row) return;
            row.className = 'row ' + (kind || 'bot');
            const bubble = row.querySelector('.bubble');
            bubble.innerHTML = '';
            const meta = document.createElement('div');
            meta.className = 'meta';
            meta.textContent = who + ':';
            bubble.appendChild(meta);
            bubble.appendChild(document.createTextNode(text));
            messagesEl.scrollTop = messagesEl.scrollHeight;
        }

        async function loadHistory() {
            const sessionId = getSessionId();
            if (!sessionId) return;

            const r = await axios.get('/api/chat/history', {
                params: { sessionId, source: SOURCE },
                timeout: 20000,
            });

            const msgs = r.data?.messages || [];
            if (!Array.isArray(msgs) || msgs.length === 0) return;

            messagesEl.innerHTML = '';
            for (const m of msgs) {
                const kind = (m.direction === 'out') ? 'user' : 'bot';
                const who = (m.direction === 'out') ? 'Ty' : 'OLIG3D';
                appendMessage(who, String(m.text ?? ''), kind);
            }
        }

        async function postChat(text) {
            const r = await axios.post('/api/chat', {
                message: text,
                sessionId: getSessionId(),  // backend zwróci sessionId jeśli tworzy nową sesję
                source: SOURCE,
            }, { timeout: 20000 });

            if (r.data?.sessionId) setSessionId(r.data.sessionId);
            return String(r.data?.reply ?? '');
        }

        async function sendText() {
            const text = inputEl.value.trim();
            if (!text || busy) return;

            busy = true;
            sendBtn.disabled = true;
            inputEl.value = '';

            appendMessage('Ty', text, 'user');

            const pendingId = 'pending-' + Date.now();
            appendMessage('OLIG3D', 'myślę...', 'bot', pendingId);

            try {
                const reply = await postChat(text);
                updateMessageById(pendingId, 'OLIG3D', reply || '[brak odpowiedzi]', 'bot');
                await loadHistory(); // dociągnij historię po zapisie
            } catch (e) {
                updateMessageById(pendingId, 'OLIG3D', '[brak odpowiedzi]', 'bot');
            } finally {
                busy = false;
                sendBtn.disabled = false;
                inputEl.focus();
            }
        }

        async function sendStl(file) {
            if (!file || busy) return;

            busy = true;
            sendBtn.disabled = true;

            appendMessage('Ty', `Wgrywam STL: ${file.name}`, 'user');

            const pendingId = 'pending-stl-' + Date.now();
            appendMessage('OLIG3D', 'liczę wycenę...', 'bot', pendingId);

            try {
                const fd = new FormData();
                fd.append('model', file);
                fd.append('material', 'PLA');

                const r = await axios.post('/api/quote-from-stl', fd, {
                    headers: { 'Content-Type': 'multipart/form-data' },
                    timeout: 600000,
                });

                // u Ciebie serwer zwykle zwraca { success:true, quote: ... }
                let q = r.data?.quote;
                if (Array.isArray(q)) q = q[0];
                if (q && q.quote) q = q.quote;

                if (!q) {
                    updateMessageById(pendingId, 'OLIG3D', 'Błąd: brak danych wyceny.', 'bot');
                } else {
                    const bd = q.breakdown || {};
                    const mat = q.material || {};
                    const time = q.time || {};
                    const lines = [
                        `JOB: ${q.jobExtId || 'brak'}`,
                        `Materiał: ${mat.name || 'PLA'} | ${mat.pricePerKg ?? '-'} zł/kg`,
                        `Czas druku: ${time.printHours ?? '-'} h`,
                        `Masa: ${q.massGrams ?? '-'} g`,
                        `Koszt materiału: ${bd.materialCost ?? '-'} zł`,
                        `Koszt druku: ${bd.printCost ?? '-'} zł`,
                        `Razem: ${q.total ?? q.totalPrice ?? '-'} zł`,
                    ].join('\n');

                    updateMessageById(pendingId, 'OLIG3D', lines, 'bot');
                }

                await loadHistory();
            } catch (e) {
                updateMessageById(pendingId, 'OLIG3D', 'Błąd wyceny STL.', 'bot');
            } finally {
                busy = false;
                sendBtn.disabled = false;
                inputEl.focus();
            }
        }

        // EVENTS
        sendBtn.addEventListener('click', () => sendText());
        inputEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendText();
            }
        });

        resetLink.addEventListener('click', (e) => {
            e.preventDefault();
            clearSession();
            messagesEl.innerHTML = '';
            inputEl.focus();
        });

        stlBtn.addEventListener('click', () => stlInput.click());
        stlInput.addEventListener('change', () => {
            const f = stlInput.files && stlInput.files[0];
            stlInput.value = '';
            if (f) sendStl(f);
        });

        // INIT
        (async () => {
            try { await loadHistory(); } catch { }
            inputEl.focus();
        })();
    </script>
</body>

</html>