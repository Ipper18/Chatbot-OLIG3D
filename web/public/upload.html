<!DOCTYPE html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wycena modelu 3D – OLIG3D</title>
    <link rel="stylesheet" href="/styles.css" />
    <style>
        .result-box {
            background: #f4f4f4;
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1.5rem;
            border: 1px solid #ddd;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .price-tag {
            font-size: 2rem;
            color: #2e7d32;
            font-weight: bold;
            display: block;
            margin-bottom: 0.5rem;
        }

        .quote-id {
            font-size: 0.8rem;
            color: #888;
            font-family: monospace;
            margin-bottom: 1rem;
            display: block;
        }

        .error {
            color: #d32f2f;
            background: #ffebee;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        .loading {
            color: #0288d1;
            font-weight: bold;
            margin-top: 1rem;
        }

        ul.details-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        ul.details-list li {
            padding: 0.5rem 0;
            border-bottom: 1px solid #eee;
        }

        ul.details-list li:last-child {
            border-bottom: none;
        }
    </style>
</head>

<body>
    <main class="container">
        <h1>Wycena modelu 3D (STL)</h1>

        <form id="quote-form">
            <div style="margin-bottom: 1rem;">
                <label style="display:block; margin-bottom: 0.5rem; font-weight: bold;">Wybierz plik (STL/OBJ):</label>
                <input type="file" name="model" id="file-input" accept=".stl,.obj" required />
            </div>

            <div style="margin-bottom: 1rem;">
                <label style="display:block; margin-bottom: 0.5rem; font-weight: bold;">Materiał:</label>
                <select name="material" id="material-input" style="padding: 0.5rem; width: 100%; max-width: 300px;">
                    <option value="PLA">PLA</option>
                    <option value="PETG">PETG</option>
                    <option value="ABS">ABS</option>
                </select>
            </div>

            <button type="submit" style="padding: 0.7rem 1.5rem; cursor: pointer;">Przeanalizuj i wyceń</button>
        </form>

        <div id="result-container"></div>
    </main>

    <script>
        const form = document.getElementById('quote-form');
        const fileInput = document.getElementById('file-input');
        const materialInput = document.getElementById('material-input');
        const resultContainer = document.getElementById('result-container');

        form.addEventListener('submit', async (e) => {
            e.preventDefault();

            // Reset widoku
            resultContainer.innerHTML = '<p class="loading">Trwa przesyłanie, analiza geometrii i kalkulacja...</p>';

            const file = fileInput.files[0];
            if (!file) {
                resultContainer.innerHTML = '<p class="error">Wybierz plik STL.</p>';
                return;
            }

            const fd = new FormData();
            fd.append('model', file);
            fd.append('material', materialInput.value);

            try {
                const res = await fetch('/api/quote-from-stl', {
                    method: 'POST',
                    body: fd
                });

                if (!res.ok) {
                    const errData = await res.json().catch(() => ({}));
                    throw new Error(errData.details || errData.error || `Błąd HTTP ${res.status}`);
                }

                const data = await res.json();
                console.log("Otrzymane dane:", data); // Debug w konsoli przeglądarki

                renderSuccess(data);

            } catch (err) {
                console.error(err);
                resultContainer.innerHTML = `<div class="error">
                    <strong>Wystąpił błąd:</strong><br>
                    ${err.message}
                </div>`;
            }
        });

        function renderSuccess(data) {
            // 1. Dane geometryczne (z FastAPI)
            const geo = data.geometry || {};

            // 2. Dane wyceny (z n8n - obiekt "quote" ze zrzutu ekranu)
            const quote = data.quote || {};

            // Mapowanie pól zgodnie z Twoim zrzutem JSON
            const price = quote.total !== undefined ? Number(quote.total).toFixed(2) : "0.00";
            const time = quote.time && quote.time.hhmmss ? quote.time.hhmmss : "---";
            const weight = quote.material && quote.material.grams ? Number(quote.material.grams).toFixed(1) : "0";
            const quoteId = quote.quoteId || "---";
            const materialUsed = quote.material && quote.material.material ? quote.material.material : materialInput.value;

            // Wyliczanie wymiarów
            let dimStr = "Brak danych";
            if (geo.bounding_box) {
                const x = Math.round(geo.bounding_box.x?.[1] - geo.bounding_box.x?.[0]);
                const y = Math.round(geo.bounding_box.y?.[1] - geo.bounding_box.y?.[0]);
                const z = Math.round(geo.height_mm || 0);
                if (!isNaN(x)) dimStr = `${x} x ${y} x ${z} mm`;
            }

            resultContainer.innerHTML = `
                <div class="result-box">
                    <h2>Wynik kalkulacji</h2>
                    <span class="quote-id">ID: ${quoteId}</span>
                    
                    <span class="price-tag">${price} PLN</span>

                    <ul class="details-list">
                        <li><strong>Wybrany materiał:</strong> ${materialUsed}</li>
                        <li><strong>Waga wydruku:</strong> ${weight} g</li>
                        <li><strong>Szacowany czas druku:</strong> ${time}</li>
                        <li><strong>Wymiary (bbox):</strong> ${dimStr}</li>
                        <li><strong>Objętość modelu:</strong> ${geo.volume_cm3 ? Number(geo.volume_cm3).toFixed(2) : 0} cm³</li>
                    </ul>
                </div>
            `;
        }
    </script>

</body>

</html>