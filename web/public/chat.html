<!doctype html>
<html lang="pl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatbot OLIG3D</title>

    <style>
        :root {
            --bg: #0b0f16;
            --card: #101826;
            --card2: #0e1522;
            --text: #e8eefc;
            --muted: #9fb0d0;
            --bubble: #1a2436;
            --bubble2: #0f3dff;
            --bubble2text: #ffffff;
            --line: rgba(255, 255, 255, .08);
            --shadow: 0 18px 60px rgba(0, 0, 0, .55);
            --radius: 26px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
            color: var(--text);
            background:
                radial-gradient(900px 500px at 50% 10%, rgba(40, 120, 255, .22), transparent 60%),
                radial-gradient(700px 450px at 10% 80%, rgba(140, 60, 255, .18), transparent 55%),
                radial-gradient(700px 450px at 90% 80%, rgba(60, 255, 200, .10), transparent 55%),
                var(--bg);
        }

        .wrap {
            width: min(1100px, 92vw);
            margin: 48px auto;
        }

        h1 {
            margin: 0 0 18px 0;
            text-align: center;
            letter-spacing: .6px;
            font-weight: 800;
            font-size: 42px;
            text-shadow: 0 6px 30px rgba(0, 0, 0, .55);
        }

        .card {
            background: linear-gradient(180deg, rgba(255, 255, 255, .05), rgba(255, 255, 255, .02));
            border: 1px solid var(--line);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 22px;
        }

        .chatbox {
            height: min(62vh, 640px);
            background: rgba(0, 0, 0, .22);
            border: 1px solid var(--line);
            border-radius: 24px;
            padding: 18px;
            overflow: auto;
            scroll-behavior: smooth;
        }

        .row {
            display: flex;
            margin: 10px 0;
        }

        .row.user {
            justify-content: flex-end;
        }

        .row.bot {
            justify-content: flex-start;
        }

        .bubble {
            max-width: min(74%, 720px);
            background: var(--bubble);
            border: 1px solid rgba(255, 255, 255, .06);
            border-radius: 18px;
            padding: 12px 14px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, .25);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .row.user .bubble {
            background: linear-gradient(180deg, rgba(15, 61, 255, .95), rgba(15, 61, 255, .75));
            color: var(--bubble2text);
            border: 1px solid rgba(255, 255, 255, .12);
        }

        .meta {
            font-size: 12px;
            opacity: .8;
            margin-bottom: 6px;
            letter-spacing: .2px;
        }

        .inputbar {
            display: flex;
            gap: 12px;
            margin-top: 14px;
            align-items: center;
        }

        #msg {
            flex: 1;
            height: 44px;
            border-radius: 12px;
            border: 1px solid var(--line);
            background: rgba(0, 0, 0, .22);
            color: var(--text);
            padding: 0 14px;
            outline: none;
        }

        #msg:focus {
            border-color: rgba(120, 170, 255, .55);
            box-shadow: 0 0 0 4px rgba(60, 120, 255, .16);
        }

        button {
            height: 44px;
            padding: 0 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: #1f5eff;
            color: #fff;
            font-weight: 700;
            cursor: pointer;
            transition: transform .06s ease, opacity .15s ease, filter .15s ease;
        }

        button:active {
            transform: scale(.985);
        }

        button:disabled {
            opacity: .55;
            cursor: not-allowed;
            filter: saturate(.5);
        }

        #stlBtn {
            background: #1f5eff;
        }

        .link {
            margin-top: 14px;
            text-align: center;
            color: rgba(180, 210, 255, .95);
            text-decoration: underline;
            cursor: pointer;
            user-select: none;
        }

        .link:hover {
            opacity: .9;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>Chatbot OLIG3D</h1>

        <div class="card">
            <div id="chat" class="chatbox"></div>

            <div class="inputbar">
                <input id="msg" type="text" placeholder="Napisz wiadomość..." autocomplete="off" />
                <button id="send">Wyślij</button>
                <button id="stlBtn" type="button">STL</button>
                <input id="stl" type="file" accept=".stl" style="display:none" />
            </div>

            <div id="newChat" class="link">Zacznij nową rozmowę</div>
        </div>
    </div>

    <script>
        const chatEl = document.getElementById('chat');
        const msgEl = document.getElementById('msg');
        const sendBtn = document.getElementById('send');
        const stlBtn = document.getElementById('stlBtn');
        const stlInput = document.getElementById('stl');
        const newChatBtn = document.getElementById('newChat');

        const API_CHAT = '/api/chat';
        const API_QUOTE_BY_JOB = '/api/quote/';          // GET /api/quote/JOB-0001
        const API_QUOTE_FROM_STL = '/api/quote-from-stl';// POST multipart

        let messages = [];
        let sessionId = null;     // NIE zapisujemy w storage -> po odświeżeniu znika
        let lastJobExtId = null;

        function makeSessionId() {
            // UUID jest bezpieczny dla backendu i DB
            if (window.crypto && crypto.randomUUID) return crypto.randomUUID();
            return 'sess-' + Date.now() + '-' + Math.random().toString(16).slice(2);
        }

        function scrollBottom() {
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function renderAll() {
            chatEl.innerHTML = '';
            for (const m of messages) {
                const row = document.createElement('div');
                row.className = 'row ' + (m.role === 'user' ? 'user' : 'bot');

                const bubble = document.createElement('div');
                bubble.className = 'bubble';

                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.textContent = (m.role === 'user') ? 'Ty:' : 'OLIG3D:';

                bubble.appendChild(meta);
                bubble.appendChild(document.createTextNode(m.text));

                row.appendChild(bubble);
                chatEl.appendChild(row);
            }
            scrollBottom();
        }

        function add(role, text) {
            messages.push({ role, text: String(text ?? '') });
            renderAll();
        }

        function setBusy(isBusy) {
            sendBtn.disabled = isBusy;
            stlBtn.disabled = isBusy;
            msgEl.disabled = isBusy;
        }

        async function safeJson(resp) {
            const ct = (resp.headers.get('content-type') || '').toLowerCase();
            if (ct.includes('application/json')) return await resp.json();
            const txt = await resp.text();
            try { return JSON.parse(txt); } catch { return { raw: txt }; }
        }

        function looksLikeBackendJsonError(s) {
            const t = String(s || '').toLowerCase();
            return t.includes('invalid input syntax for type json')
                || t.includes('token "') && t.includes('" is invalid')
                || t.includes('syntax error') && t.includes('json')
                || t.includes('[brak odpowiedzi]');
        }

        function formatJobQuote(jobExtId, quoteObj) {
            const q = quoteObj || {};
            const job = jobExtId || q.jobExtId || q.job_ext_id || q.new_job_ext_id || null;
            const material = q.material || q?.pricing?.material || 'PLA';

            const total =
                q.total ??
                q.price_total ??
                q?.pricing?.total ??
                q?.pricing?.price_total ??
                q?.result?.total;

            const weightG =
                q.weight_g ??
                q?.material?.grams ??
                q?.result?.weight_g;

            const time =
                q.time_hhmmss ??
                q?.time?.hhmmss ??
                q?.result?.time_hhmmss;

            const lines = [
                `JOB: ${job || (jobExtId || 'JOB-????')}`,
                `Materiał: ${material}`,
            ];
            if (total != null) lines.push(`Cena: ${total}`);
            if (weightG != null) lines.push(`Waga [g]: ${weightG}`);
            if (time) lines.push(`Czas: ${time}`);

            return lines.join('\n');
        }

        async function fetchJob(jobExtId) {
            const url = API_QUOTE_BY_JOB + encodeURIComponent(jobExtId);
            const resp = await fetch(url, { method: 'GET' });
            const data = await safeJson(resp);

            if (!resp.ok || !data || data.success === false) {
                add('bot', `Nie znaleziono danych dla ${jobExtId}.`);
                return;
            }

            // server.js: { success:true, jobExtId, quote, ... }
            const q = data.quote || {};
            add('bot', formatJobQuote(data.jobExtId || jobExtId, q));
        }

        async function sendText(text) {
            const msg = (text || '').trim();
            if (!msg) return;

            add('user', msg);

            // JOB-xxxx -> pobierz dane joba bez dotykania /api/chat
            if (/^JOB-\d{4}$/i.test(msg)) {
                lastJobExtId = msg.toUpperCase();
                setBusy(true);
                try {
                    await fetchJob(lastJobExtId);
                } catch (e) {
                    add('bot', 'Błąd pobierania JOB.');
                } finally {
                    setBusy(false);
                }
                return;
            }

            if (!sessionId) sessionId = makeSessionId();

            setBusy(true);
            try {
                const resp = await fetch(API_CHAT, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        message: msg,
                        sessionId: sessionId,
                    }),
                });

                const data = await safeJson(resp);

                // próbuj wyciągnąć reply z różnych kształtów odpowiedzi
                let reply =
                    data?.reply ??
                    data?.output?.reply ??
                    data?.result?.reply ??
                    (typeof data?.raw === 'string' ? data.raw : null);

                // jeśli backend zwraca śmieci / błąd JSON z DB -> nie psujemy UX, robimy echo po stronie klienta
                if (!reply || looksLikeBackendJsonError(reply)) {
                    reply = `Echo: ${msg}`;
                }

                // jeśli backend odda nowe sessionId -> przyjmij, ale nie nadpisuj null
                if (data?.sessionId) sessionId = data.sessionId;

                add('bot', reply);
            } catch (e) {
                add('bot', `Błąd połączenia. Echo: ${msg}`);
            } finally {
                setBusy(false);
            }
        }

        async function sendStl(file) {
            if (!file) return;
            if (!sessionId) sessionId = makeSessionId();

            add('user', `Wgrywam STL: ${file.name}`);
            setBusy(true);

            try {
                const fd = new FormData();
                fd.append('stlFile', file, file.name);
                // jeśli backend kiedyś zacznie używać sessionId do powiązania -> już jest
                fd.append('sessionId', sessionId);

                const resp = await fetch(API_QUOTE_FROM_STL, { method: 'POST', body: fd });
                const data = await safeJson(resp);

                if (!resp.ok || !data || data.success === false) {
                    add('bot', data?.error || 'Błąd wyceny STL.');
                    return;
                }

                // server.js: { success:true, geometry, quote }
                // a n8n może zwrócić quote jako obiekt lub zagnieżdżony payload
                const q = data.quote || {};
                const jobExtId =
                    data.jobExtId || data.job_ext_id ||
                    q.jobExtId || q.job_ext_id || q.new_job_ext_id || q.job ||
                    q?.result?.jobExtId;

                if (jobExtId) lastJobExtId = String(jobExtId).toUpperCase();

                add('bot', formatJobQuote(jobExtId, q));
            } catch (e) {
                add('bot', 'Błąd uploadu STL.');
            } finally {
                setBusy(false);
            }
        }

        // UI events
        sendBtn.addEventListener('click', () => {
            const text = msgEl.value;
            msgEl.value = '';
            sendText(text);
        });

        msgEl.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                e.preventDefault();
                sendBtn.click();
            }
        });

        stlBtn.addEventListener('click', () => stlInput.click());
        stlInput.addEventListener('change', () => {
            const file = stlInput.files && stlInput.files[0];
            stlInput.value = '';
            sendStl(file);
        });

        newChatBtn.addEventListener('click', () => {
            messages = [];
            sessionId = null;
            lastJobExtId = null;
            renderAll();
            msgEl.focus();
        });

        // start
        renderAll();
        msgEl.focus();
    </script>
</body>

</html>