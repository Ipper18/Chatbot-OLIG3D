<!doctype html>
<html lang="pl">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Chatbot OLIG3D</title>
    <style>
        :root {
            --bg1: #070A10;
            --bg2: #0A1222;
            --card: rgba(255, 255, 255, 0.06);
            --card2: rgba(255, 255, 255, 0.08);
            --border: rgba(255, 255, 255, 0.10);
            --text: #EAF0FF;
            --muted: rgba(234, 240, 255, 0.70);
            --blue: #2E7BFF;
            --shadow: 0 20px 60px rgba(0, 0, 0, 0.55);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, Noto Sans, sans-serif;
            color: var(--text);
            min-height: 100vh;
            background: radial-gradient(900px 500px at 50% 5%, rgba(46, 123, 255, 0.35), transparent 60%),
                radial-gradient(600px 380px at 15% 85%, rgba(160, 80, 255, 0.25), transparent 60%),
                radial-gradient(700px 420px at 85% 80%, rgba(0, 220, 255, 0.15), transparent 60%),
                linear-gradient(180deg, var(--bg1), var(--bg2));
            display: flex;
            justify-content: center;
            align-items: flex-start;
            padding: 48px 16px;
        }

        .wrap {
            width: min(1080px, 96vw);
        }

        h1 {
            text-align: center;
            font-weight: 800;
            letter-spacing: 0.5px;
            font-size: 42px;
            text-shadow: 0 8px 30px rgba(0, 0, 0, 0.7);
            margin-bottom: 22px;
        }

        .panel {
            background: rgba(0, 0, 0, 0.22);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 28px;
            box-shadow: var(--shadow);
            padding: 18px;
        }

        .chatbox {
            height: 520px;
            border-radius: 22px;
            background: rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(255, 255, 255, 0.08);
            padding: 18px;
            overflow: auto;
        }

        .row {
            display: flex;
            margin: 10px 0;
            gap: 12px;
        }

        .row.user {
            justify-content: flex-end;
        }

        .row.bot {
            justify-content: flex-start;
        }

        .bubble {
            max-width: min(720px, 80%);
            padding: 12px 14px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.35);
            white-space: pre-wrap;
            word-break: break-word;
        }

        .user .bubble {
            background: linear-gradient(180deg, rgba(46, 123, 255, 0.95), rgba(31, 97, 255, 0.95));
            border-color: rgba(255, 255, 255, 0.12);
        }

        .bot .bubble {
            background: rgba(255, 255, 255, 0.06);
        }

        .badge {
            display: block;
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 6px;
            font-weight: 700;
            letter-spacing: 0.2px;
        }

        .composer {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 14px;
        }

        .input {
            flex: 1;
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(0, 0, 0, 0.28);
            color: var(--text);
            padding: 0 14px;
            outline: none;
        }

        .btn {
            height: 44px;
            padding: 0 16px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(46, 123, 255, 0.95);
            color: #fff;
            font-weight: 800;
            cursor: pointer;
        }

        .material {
            height: 44px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.10);
            background: rgba(0, 0, 0, 0.28);
            color: var(--text);
            padding: 0 10px;
            min-width: 100px;
        }

        .newchat {
            text-align: center;
            margin-top: 12px;
        }

        .newchat a {
            color: rgba(234, 240, 255, 0.75);
            text-decoration: underline;
            cursor: pointer;
        }

        .card {
            background: rgba(0, 0, 0, 0.20);
            border: 1px solid rgba(255, 255, 255, 0.10);
            border-radius: 14px;
            padding: 12px;
        }

        .card .title {
            font-weight: 900;
            letter-spacing: 0.2px;
            margin-bottom: 8px;
        }

        .kv {
            display: flex;
            justify-content: space-between;
            padding: 4px 0;
            border-top: 1px dashed rgba(255, 255, 255, 0.12);
        }

        .kv:first-of-type {
            border-top: none;
        }

        .big {
            text-align: center;
            font-size: 30px;
            font-weight: 900;
            margin: 8px 0;
        }

        .sub {
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            margin-bottom: 10px;
        }

        .grid2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        @media(max-width:720px) {
            .grid2 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>Chatbot OLIG3D</h1>
        <div class="panel">
            <div id="chatbox" class="chatbox"></div>
            <div class="composer">
                <input id="messageInput" class="input" placeholder="Napisz wiadomość..." />
                <button id="sendBtn" class="btn">Wyślij</button>
                <button id="stlBtn" class="btn">STL</button>
                <select id="materialSelect" class="material">
                    <option>PLA</option>
                    <option>PETG</option>
                    <option>ASA</option>
                    <option>ABS</option>
                    <option>TPU</option>
                </select>
                <input id="fileInput" type="file" accept=".stl,.obj" hidden />
            </div>
            <div class="newchat"><a id="newChatLink">Zacznij nową rozmowę</a></div>
        </div>
    </div>

    <script>
        let sessionId = crypto.randomUUID();
        let pendingFile = null; // plik do wysyłki po kliknięciu "Wyślij"

        const chat = document.getElementById('chatbox');
        const input = document.getElementById('messageInput');
        const sendBtn = document.getElementById('sendBtn');
        const stlBtn = document.getElementById('stlBtn');
        const fileInput = document.getElementById('fileInput');
        const materialSel = document.getElementById('materialSelect');
        const newChat = document.getElementById('newChatLink');

        const API_CHAT = '/api/chat';
        const API_QUOTE = '/api/quote/';
        const API_STL = '/api/quote-from-stl';

        const addMsg = (role, text, html = false) => {
            const row = document.createElement('div');
            row.className = 'row ' + role;
            const bubble = document.createElement('div');
            bubble.className = 'bubble';
            bubble.innerHTML = `<span class="badge">${role === 'user' ? 'Ty:' : 'OLIG3D:'}</span>` + (html ? text : text.replace(/</g, '&lt;'));
            row.appendChild(bubble); chat.appendChild(row); chat.scrollTop = chat.scrollHeight;
        };

        const renderQuote = q => {
            const c = q.currency || 'PLN', b = q.breakdown || {}, m = q.material || {}, t = q.time || {}, meta = q.meta || {}, job = q.jobExtId || q.jobId || '-';
            return `
      <div class="card">
        <div class="title">Wycena STL</div>
        <div class="sub">${q.filename || job}</div>
        <div class="big">${(q.total ?? 0).toFixed(2)} ${c}</div>
        <div class="kv"><div>Materiał</div><div>${m.material || '-'}</div></div>
        <div class="kv"><div>Waga</div><div>${m.grams ? m.grams.toFixed(2) + ' g' : '-'}</div></div>
        <div class="kv"><div>Czas</div><div>${t.hhmmss || '-'}</div></div>
        <div class="kv"><div>Wymiary</div><div>${q.dimensions || '-'}</div></div>
        <div class="kv"><div>Objętość</div><div>${q.volume ? Number(q.volume).toFixed(2) + ' cm³' : '-'}</div></div>
        <div class="grid2" style="margin-top:10px;">
          <div class="card"><div class="title" style="font-size:14px;">Składowe</div>
            <div class="kv"><div>Czas pracy</div><div>${b.timeCost?.toFixed(2)} ${c}</div></div>
            <div class="kv"><div>Materiał</div><div>${b.materialCost?.toFixed(2)} ${c}</div></div>
            <div class="kv"><div>Energia</div><div>${b.energyCost?.toFixed(2)} ${c}</div></div>
            <div class="kv"><div>Marża</div><div>${b.margin?.toFixed(2)} ${c}</div></div>
          </div>
        </div>
      </div>`;
        };

        async function sendMessage() {
            const msg = input.value.trim();
            if (!msg && !pendingFile) return;
            addMsg('user', msg || ('[plik: ' + pendingFile.name + ']'));
            input.value = '';
            if (pendingFile) {
                const fd = new FormData();
                fd.append('model', pendingFile, pendingFile.name);
                fd.append('material', materialSel.value);
                const r = await fetch(API_STL, { method: 'POST', body: fd });
                const d = await r.json();
                const q = d?.quote;
                if (d?.success && q) addMsg('bot', renderQuote(q), true);
                else addMsg('bot', 'Błąd wyceny STL.');
                pendingFile = null;
                return;
            }
            // normalne wiadomości
            const res = await fetch(API_CHAT, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ message: msg, sessionId }) });
            const data = await res.json().catch(() => null);
            const reply = data?.reply || data?.output?.reply || data?.result?.reply || 'Echo: ' + msg;
            addMsg('bot', reply);
        }

        async function handleJob(msg) {
            const job = msg.trim().toUpperCase();
            const r = await fetch(API_QUOTE + job);
            const d = await r.json();
            const q = d?.quote || d;
            if (q) addMsg('bot', renderQuote(q), true);
            else addMsg('bot', 'Nie znaleziono ' + job);
        }

        sendBtn.onclick = sendMessage;
        input.onkeydown = e => { if (e.key === 'Enter') sendMessage(); };
        stlBtn.onclick = () => fileInput.click();
        fileInput.onchange = () => { pendingFile = fileInput.files[0]; if (pendingFile) addMsg('user', 'Wybrano plik: ' + pendingFile.name); };
        newChat.onclick = () => { chat.innerHTML = ''; sessionId = crypto.randomUUID(); pendingFile = null; };
    </script>
</body>

</html>