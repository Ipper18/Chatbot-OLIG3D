<!doctype html>
<html lang="pl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Chatbot OLIG3D</title>

    <style>
        :root {
            --bg1: #050914;
            --bg2: #091a3a;
            --card: rgba(10, 18, 40, .72);
            --card2: rgba(10, 18, 40, .52);
            --stroke: rgba(255, 255, 255, .08);
            --text: #e9f0ff;
            --muted: rgba(233, 240, 255, .72);
            --accent: #2f6bff;
            --accent2: #3e7bff;
            --shadow: 0 20px 60px rgba(0, 0, 0, .45);
            --radius: 22px;
        }

        * {
            box-sizing: border-box
        }

        html,
        body {
            height: 100%
        }

        body {
            margin: 0;
            font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Apple Color Emoji", "Segoe UI Emoji";
            color: var(--text);
            background:
                radial-gradient(1200px 600px at 50% -10%, rgba(47, 107, 255, .35), transparent 60%),
                radial-gradient(900px 500px at 15% 115%, rgba(155, 81, 224, .18), transparent 60%),
                linear-gradient(180deg, var(--bg2), var(--bg1) 55%, #060816);
            overflow: hidden;
            /* klucz: strona nie rośnie, scroll jest w środku */
        }

        .page {
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 28px 28px 22px;
            gap: 18px;
        }

        .title {
            text-align: center;
            font-weight: 800;
            letter-spacing: .6px;
            font-size: 64px;
            line-height: 1;
            margin: 0;
            text-shadow: 0 20px 40px rgba(0, 0, 0, .35);
            user-select: none;
        }

        .shell {
            flex: 1;
            min-height: 0;
            /* klucz dla scrolla w flexie */
            background: rgba(255, 255, 255, .03);
            border: 1px solid var(--stroke);
            border-radius: 28px;
            box-shadow: var(--shadow);
            backdrop-filter: blur(12px);
            display: flex;
            overflow: hidden;
        }

        /* LEFT PANEL */
        .left {
            width: 360px;
            padding: 18px;
            border-right: 1px solid var(--stroke);
            background: linear-gradient(180deg, rgba(255, 255, 255, .02), rgba(255, 255, 255, .01));
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .panel {
            background: var(--card);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: 18px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, .28);
        }

        .panel h2 {
            margin: 0 0 12px;
            font-size: 18px;
            font-weight: 700;
            color: var(--text);
        }

        .total-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 6px;
            padding: 12px 8px 6px;
        }

        .total-label {
            color: var(--muted);
            font-size: 12px;
            letter-spacing: .4px;
            text-transform: uppercase;
        }

        .total {
            font-size: 36px;
            font-weight: 850;
            letter-spacing: .4px;
        }

        .jobid {
            margin-top: 4px;
            color: var(--muted);
            font-size: 12px;
        }

        .rows {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 14px;
        }

        .row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 12px 14px;
            border-radius: 16px;
            background: rgba(255, 255, 255, .03);
            border: 1px solid rgba(255, 255, 255, .06);
        }

        .row .k {
            color: var(--muted);
            font-size: 14px;
        }

        .row .v {
            font-weight: 700;
            color: var(--text);
            font-size: 14px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 170px;
            text-align: right;
        }

        .section-title {
            margin: 14px 0 10px;
            color: var(--muted);
            font-size: 12px;
            letter-spacing: .4px;
            text-transform: uppercase;
        }

        /* CHAT AREA */
        .right {
            flex: 1;
            min-width: 0;
            display: flex;
            flex-direction: column;
            min-height: 0;
            /* klucz */
            padding: 18px;
            gap: 12px;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
            padding: 8px 10px 0;
        }

        .hint {
            color: var(--muted);
            font-size: 13px;
        }

        .session {
            color: var(--muted);
            font-size: 13px;
        }

        .chat-card {
            flex: 1;
            min-height: 0;
            /* klucz: żeby messages mogły scrollować */
            background: var(--card2);
            border: 1px solid var(--stroke);
            border-radius: var(--radius);
            padding: 14px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            overflow: hidden;
            /* żeby scroll był wewnątrz .messages */
        }

        .messages {
            flex: 1;
            min-height: 0;
            overflow-y: auto;
            /* <<< scroll chat */
            padding: 8px 4px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .msg {
            max-width: 72%;
            padding: 12px 14px;
            border-radius: 18px;
            border: 1px solid rgba(255, 255, 255, .08);
            background: rgba(255, 255, 255, .03);
            box-shadow: 0 12px 30px rgba(0, 0, 0, .18);
            white-space: pre-wrap;
            word-break: break-word;
            font-size: 14px;
            line-height: 1.35;
        }

        .msg .who {
            display: block;
            font-size: 11px;
            opacity: .7;
            margin-bottom: 6px;
            letter-spacing: .3px;
            text-transform: uppercase;
        }

        .msg.bot {
            align-self: flex-start;
            border-top-left-radius: 10px;
        }

        .msg.user {
            align-self: flex-end;
            background: rgba(47, 107, 255, .18);
            border-color: rgba(47, 107, 255, .25);
            border-top-right-radius: 10px;
        }

        .composer {
            display: flex;
            align-items: flex-end;
            gap: 10px;
            padding: 10px 4px 2px;
        }

        .input {
            flex: 1;
            min-width: 0;
            height: 44px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(0, 0, 0, .18);
            color: var(--text);
            padding: 0 14px;
            outline: none;
        }

        .input::placeholder {
            color: rgba(233, 240, 255, .45)
        }

        .send {
            height: 44px;
            padding: 0 18px;
            border-radius: 14px;
            border: 0;
            background: linear-gradient(180deg, var(--accent2), var(--accent));
            color: white;
            font-weight: 800;
            cursor: pointer;
            box-shadow: 0 18px 40px rgba(47, 107, 255, .25);
        }

        .send:disabled {
            opacity: .55;
            cursor: not-allowed
        }

        .toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            padding: 0 4px 10px;
        }

        .pill {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 14px;
            border: 1px solid rgba(255, 255, 255, .10);
            background: rgba(0, 0, 0, .12);
            color: var(--muted);
            font-size: 13px;
        }

        .select,
        .file {
            border: 0;
            outline: none;
            background: transparent;
            color: var(--text);
            font-weight: 700;
            font-size: 13px;
        }

        .link {
            text-align: center;
            color: var(--muted);
            font-size: 12px;
            padding-top: 6px;
            user-select: none;
        }

        .link a {
            color: rgba(233, 240, 255, .75)
        }
    </style>
</head>

<body>
    <div class="page">
        <h1 class="title">Chatbot OLIG3D</h1>

        <div class="shell">
            <!-- LEFT -->
            <aside class="left">
                <div class="panel">
                    <h2>Wycena STL</h2>

                    <div class="total-wrap">
                        <div class="total-label">Całkowity koszt</div>
                        <div class="total"><span id="uiTotal">0.00</span> <span id="uiCurrency">PLN</span></div>
                        <div class="jobid">JOB <span id="uiJob">—</span></div>
                    </div>

                    <div class="rows">
                        <div class="row">
                            <div class="k">Materiał</div>
                            <div class="v" id="uiMaterial">—</div>
                        </div>
                        <div class="row">
                            <div class="k">Waga</div>
                            <div class="v" id="uiWeight">—</div>
                        </div>
                        <div class="row">
                            <div class="k">Czas</div>
                            <div class="v" id="uiTime">—</div>
                        </div>
                        <div class="row">
                            <div class="k">Wymiary</div>
                            <div class="v" id="uiDims">—</div>
                        </div>
                        <div class="row">
                            <div class="k">Objętość</div>
                            <div class="v" id="uiVolume">—</div>
                        </div>
                    </div>

                    <div class="section-title">Składowe ceny</div>
                    <div class="rows">
                        <div class="row">
                            <div class="k">Materiał</div>
                            <div class="v" id="uiCostMaterial">—</div>
                        </div>
                        <div class="row">
                            <div class="k">Czas pracy maszyny</div>
                            <div class="v" id="uiCostTime">—</div>
                        </div>
                        <div class="row">
                            <div class="k">Energia</div>
                            <div class="v" id="uiCostEnergy">—</div>
                        </div>
                        <div class="row">
                            <div class="k">Marża i obsługa</div>
                            <div class="v" id="uiCostMargin">—</div>
                        </div>
                    </div>
                </div>
            </aside>

            <!-- RIGHT -->
            <main class="right">
                <div class="topbar">
                    <div class="hint">OLIG3D: Napisz wiadomość lub wybierz STL i kliknij „Wyślij”.</div>
                    <div class="session">Sesja: <span id="uiSession">—</span></div>
                </div>

                <section class="chat-card">
                    <div class="messages" id="messages"></div>

                    <div class="toolbar">
                        <div class="pill">
                            <span style="font-weight:800;color:rgba(233,240,255,.85)">STL</span>
                        </div>

                        <div class="pill">
                            <label style="display:flex;align-items:center;gap:10px;">
                                <span style="font-weight:800;color:rgba(233,240,255,.85)">Materiał</span>
                                <select id="materialSelect" class="select">
                                    <option value="PLA">PLA</option>
                                    <option value="ABS">ABS</option>
                                    <option value="TPU">TPU</option>
                                    <option value="PETG">PETG</option>
                                </select>
                            </label>
                        </div>

                        <div class="pill" style="flex:1;justify-content:space-between;">
                            <input id="fileInput" class="file" type="file" accept=".stl" />
                            <span id="fileName" style="color:rgba(233,240,255,.65);font-size:12px;">Nie wybrano
                                pliku</span>
                        </div>
                    </div>

                    <div class="composer">
                        <input id="textInput" class="input" placeholder="Napisz wiadomość..." />
                        <button id="sendBtn" class="send">Wyślij</button>
                    </div>

                    <div class="link"><a href="#" id="newChat">Zacznij nową rozmowę</a></div>
                </section>
            </main>
        </div>
    </div>

    <script>
        // USTAW: webhook n8n
        const WEBHOOK_URL = "https://n8n.olig.site/webhook/chat";
        const SOURCE = "web-3d.olig.site";

        // --------- Session ----------
        function getOrCreateSessionId() {
            const key = "olig3d_session_id";
            let sid = localStorage.getItem(key);
            if (!sid) {
                // krótki, czytelny identyfikator
                sid = "sess_" + Math.random().toString(36).slice(2, 10) + Math.random().toString(36).slice(2, 10);
                localStorage.setItem(key, sid);
            }
            return sid;
        }

        let sessionId = getOrCreateSessionId();

        // --------- UI helpers ----------
        const $ = (id) => document.getElementById(id);

        function fmtMoney(n) {
            if (n === null || n === undefined || n === "" || Number.isNaN(Number(n))) return "—";
            return Number(n).toFixed(2);
        }
        function fmtNumber(n, digits = 2) {
            if (n === null || n === undefined || n === "" || Number.isNaN(Number(n))) return "—";
            return Number(n).toFixed(digits);
        }
        function setText(id, value) {
            const el = $(id);
            if (!el) return;
            el.textContent = (value === null || value === undefined || value === "" ? "—" : String(value));
        }

        function scrollChatToBottom() {
            const box = $("messages");
            if (!box) return;
            box.scrollTop = box.scrollHeight;
        }

        // --------- Left panel update ----------
        // Oczekiwany kształt z n8n:
        // response.quote = {
        //   jobExtId, total, currency,
        //   material:{type, grams},
        //   time:{minutes, hhmmss},
        //   breakdown:{materialCost, timeCost, energyCost, margin},
        //   dims?, volume?
        // }
        function updateLeftPanelFromQuote(q) {
            if (!q || typeof q !== "object") return;

            const job = q.jobExtId ?? q.ext_id ?? q.job ?? null;
            const currency = q.currency ?? "PLN";
            const total = q.total ?? null;

            setText("uiJob", job ? job.replace(/^JOB-/, "") : "—");
            setText("uiCurrency", currency || "PLN");
            setText("uiTotal", fmtMoney(total));

            // Materiał i waga
            const matType = q.material?.type ?? q.material ?? q.mat ?? null;
            const grams = q.material?.grams ?? q.grams ?? q.weight_g ?? q.estimated_weight_g ?? null;

            setText("uiMaterial", matType ? matType : "—");
            setText("uiWeight", grams !== null && grams !== undefined ? `${fmtNumber(grams, 2)} g` : "—");

            // Czas
            const minutes = q.time?.minutes ?? q.minutes ?? q.time_min ?? q.estimated_time_min ?? null;
            const hhmmss = q.time?.hhmmss ?? null;
            setText("uiTime", minutes !== null && minutes !== undefined
                ? (hhmmss ? `${minutes} min (${hhmmss})` : `${minutes} min`)
                : "—"
            );

            // Wymiary/objętość (jeśli kiedyś dodasz w backendzie)
            const dims = q.dims ?? q.dimensions ?? null;
            const vol = q.volume ?? q.volume_cm3 ?? q.volume_mm3 ?? null;

            setText("uiDims", dims ? String(dims) : "—");
            setText("uiVolume", vol !== null && vol !== undefined ? String(vol) : "—");

            // Składowe ceny
            const b = q.breakdown ?? {};
            const materialCost = b.materialCost ?? q.material_cost ?? null;
            const timeCost = b.timeCost ?? q.time_cost ?? null;
            const energyCost = b.energyCost ?? q.energy_cost ?? null;
            const margin = b.margin ?? q.margin ?? null;

            setText("uiCostMaterial", materialCost !== null && materialCost !== undefined ? `${fmtMoney(materialCost)} ${currency}` : "—");
            setText("uiCostTime", timeCost !== null && timeCost !== undefined ? `${fmtMoney(timeCost)} ${currency}` : "—");
            setText("uiCostEnergy", energyCost !== null && energyCost !== undefined ? `${fmtMoney(energyCost)} ${currency}` : "—");
            setText("uiCostMargin", margin !== null && margin !== undefined ? `${fmtMoney(margin)} ${currency}` : "—");
        }

        function clearLeftPanel() {
            setText("uiTotal", "0.00");
            setText("uiCurrency", "PLN");
            setText("uiJob", "—");
            setText("uiMaterial", "—");
            setText("uiWeight", "—");
            setText("uiTime", "—");
            setText("uiDims", "—");
            setText("uiVolume", "—");
            setText("uiCostMaterial", "—");
            setText("uiCostTime", "—");
            setText("uiCostEnergy", "—");
            setText("uiCostMargin", "—");
        }

        // --------- Chat rendering ----------
        function addMessage(who, text, kind) {
            const el = document.createElement("div");
            el.className = "msg " + (kind || "bot");

            const w = document.createElement("span");
            w.className = "who";
            w.textContent = who;

            const t = document.createElement("div");
            t.textContent = text ?? "";

            el.appendChild(w);
            el.appendChild(t);

            $("messages").appendChild(el);
            scrollChatToBottom();
        }

        // --------- Network ----------
        async function postJSON(url, data) {
            const res = await fetch(url, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify(data),
            });
            const txt = await res.text();
            try {
                return JSON.parse(txt);
            } catch (e) {
                // fallback - pokaż surowe
                return { success: false, reply: "[brak odpowiedzi]", raw: txt };
            }
        }

        function setBusy(busy) {
            $("sendBtn").disabled = !!busy;
            $("textInput").disabled = !!busy;
            $("fileInput").disabled = !!busy;
            $("materialSelect").disabled = !!busy;
        }

        async function send() {
            const input = $("textInput");
            const msg = (input.value || "").trim();
            const file = $("fileInput").files?.[0] || null;
            const material = $("materialSelect").value;

            if (!msg && !file) return;

            // UI message (user)
            if (file) {
                addMessage("Ty:", `Wysyłam STL: ${file.name}\nMateriał: ${material}`, "user");
            } else {
                addMessage("Ty:", msg, "user");
            }

            input.value = "";
            setBusy(true);

            const payload = {
                message: file ? `STL:${file.name}` : msg,
                sessionId,
                source: SOURCE,
                material,
            };

            let data;
            try {
                data = await postJSON(WEBHOOK_URL, payload);
            } catch (err) {
                addMessage("OLIG3D:", "Błąd połączenia z serwerem.", "bot");
                setBusy(false);
                return;
            }

            // sesja może wrócić z backendu (utrzymuj spójność)
            if (data?.sessionId) {
                sessionId = data.sessionId;
                localStorage.setItem("olig3d_session_id", sessionId);
                setText("uiSession", sessionId);
            }

            // bot reply
            const reply = (data && typeof data.reply === "string" && data.reply.trim() !== "")
                ? data.reply
                : "[brak odpowiedzi]";
            addMessage("OLIG3D:", reply, "bot");

            // update left panel if quote present
            if (data?.quote) {
                updateLeftPanelFromQuote(data.quote);
            }

            setBusy(false);
        }

        // --------- Boot ----------
        function boot() {
            setText("uiSession", sessionId);

            addMessage("OLIG3D:", "Cześć! Napisz wiadomość lub wybierz STL i kliknij „Wyślij”.", "bot");

            $("sendBtn").addEventListener("click", send);
            $("textInput").addEventListener("keydown", (e) => {
                if (e.key === "Enter") send();
            });

            $("fileInput").addEventListener("change", () => {
                const f = $("fileInput").files?.[0];
                setText("fileName", f ? f.name : "Nie wybrano pliku");
            });

            $("newChat").addEventListener("click", (e) => {
                e.preventDefault();
                localStorage.removeItem("olig3d_session_id");
                sessionId = getOrCreateSessionId();
                setText("uiSession", sessionId);

                $("messages").innerHTML = "";
                clearLeftPanel();
                addMessage("OLIG3D:", "Nowa rozmowa. Wpisz np. JOB-0050.", "bot");
            });
        }

        boot();
    </script>
</body>

</html>