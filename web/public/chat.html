<!doctype html>
<html lang="pl">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Chatbot OLIG3D</title>
    <style>
        :root {
            color-scheme: dark;
        }

        body {
            margin: 0;
            font-family: system-ui, Arial;
            background: #0b0f14;
            color: #e8eef6;
        }

        .wrap {
            max-width: 980px;
            margin: 40px auto;
            padding: 0 16px;
        }

        h1 {
            text-align: center;
            margin: 0 0 18px;
            font-size: 34px;
        }

        .card {
            background: #0f1722;
            border-radius: 22px;
            padding: 18px;
            box-shadow: 0 18px 40px rgba(0, 0, 0, .45);
        }

        .chatbox {
            height: 560px;
            overflow: auto;
            padding: 18px;
            border-radius: 18px;
            background: #0b111a;
        }

        .row {
            display: flex;
            margin: 10px 0;
        }

        .row.user {
            justify-content: flex-end;
        }

        .bubble {
            max-width: 72%;
            padding: 12px 14px;
            border-radius: 16px;
            line-height: 1.35;
            white-space: pre-wrap;
        }

        .user .bubble {
            background: #1e6bff;
            color: #fff;
            border-bottom-right-radius: 6px;
        }

        .bot .bubble {
            background: #1a2330;
            color: #e8eef6;
            border-bottom-left-radius: 6px;
        }

        .meta {
            font-size: 12px;
            opacity: .75;
            margin-bottom: 6px;
        }

        .inputbar {
            display: flex;
            gap: 10px;
            margin-top: 12px;
            align-items: center;
        }

        input[type="text"] {
            flex: 1;
            padding: 12px 14px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, .12);
            background: #0b111a;
            color: #e8eef6;
            outline: none;
        }

        button {
            padding: 12px 14px;
            border-radius: 12px;
            border: 0;
            cursor: pointer;
            background: #1e6bff;
            color: #fff;
            font-weight: 600;
        }

        .link {
            display: block;
            text-align: center;
            margin-top: 10px;
            color: #9bbcff;
            cursor: pointer;
            user-select: none;
        }

        .link:hover {
            text-decoration: underline;
        }
    </style>
</head>

<body>
    <div class="wrap">
        <h1>Chatbot OLIG3D</h1>
        <div class="card">
            <div id="chat" class="chatbox"></div>

            <div class="inputbar">
                <input id="msg" type="text" placeholder="Napisz wiadomość..." autocomplete="off" />
                <button id="send">Wyślij</button>
                <button id="stlBtn" type="button">STL</button>
                <input id="stl" type="file" accept=".stl" style="display:none" />
            </div>

            <div id="newChat" class="link">Zacznij nową rozmowę</div>
        </div>
    </div>

    <script>
        // Tylko bieżąca sesja (RAM). Po reload/nowa rozmowa wszystko znika.
        let sessionId = null;
        const messages = []; // { role: 'user'|'assistant', text: string }

        const chatEl = document.getElementById('chat');
        const msgEl = document.getElementById('msg');
        const sendEl = document.getElementById('send');
        const stlBtn = document.getElementById('stlBtn');
        const stlInp = document.getElementById('stl');
        const newChat = document.getElementById('newChat');

        function ensureSessionId() {
            if (!sessionId) sessionId = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now()));
            return sessionId;
        }

        function render() {
            chatEl.innerHTML = '';
            for (const m of messages) {
                const row = document.createElement('div');
                row.className = 'row ' + (m.role === 'user' ? 'user' : 'bot');

                const bubble = document.createElement('div');
                bubble.className = 'bubble';

                const meta = document.createElement('div');
                meta.className = 'meta';
                meta.textContent = (m.role === 'user') ? 'Ty:' : 'OLIG3D:';

                bubble.appendChild(meta);
                bubble.appendChild(document.createTextNode(m.text));

                row.appendChild(bubble);
                chatEl.appendChild(row);
            }
            chatEl.scrollTop = chatEl.scrollHeight;
        }

        function add(role, text) {
            messages.push({ role, text: String(text ?? '') });
            render();
        }

        function formatQuote(q) {
            // Bezpiecznie, bo czasem API może zwrócić inny kształt
            const job = q?.jobExtId ?? q?.jobId ?? 'JOB-????';
            const mat = q?.material?.material ?? q?.material ?? 'PLA';
            const ppk = q?.material?.pricePerKg ?? q?.pricePerKg ?? '';
            const total = q?.total ?? '';
            const cur = q?.currency ?? 'PLN';

            const dims = q?.dimensions ?? '';
            const grams = q?.material?.grams ?? q?.grams ?? '';
            const time = q?.time?.hhmmss ?? q?.time?.minutes ? `${q.time.minutes} min` : '';

            const materialCost = q?.breakdown?.materialCost ?? '';
            const timeCost = q?.breakdown?.timeCost ?? '';
            const energyCost = q?.breakdown?.energyCost ?? '';
            const margin = q?.breakdown?.margin ?? '';

            return [
                `JOB: ${job}`,
                `Materiał: ${mat}${ppk ? ` | ${ppk} zł/kg` : ''}`,
                dims ? `Wymiary: ${dims}` : null,
                time ? `Czas druku: ${time}` : null,
                grams ? `Masa: ${grams} g` : null,
                materialCost !== '' ? `Koszt materiału: ${materialCost} zł` : null,
                timeCost !== '' ? `Koszt czasu: ${timeCost} zł` : null,
                energyCost !== '' ? `Koszt energii: ${energyCost} zł` : null,
                margin !== '' ? `Marża: ${margin} zł` : null,
                total !== '' ? `Razem: ${total} ${cur}` : null,
            ].filter(Boolean).join('\n');
        }

        async function sendMessage() {
            const text = msgEl.value.trim();
            if (!text) return;

            ensureSessionId();
            add('user', text);
            msgEl.value = '';

            try {
                const r = await fetch('/api/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text, sessionId })
                });

                const data = await r.json().catch(() => ({}));
                const reply =
                    data?.reply ??
                    data?.output?.reply ??
                    data?.data?.reply ??
                    (typeof data === 'string' ? data : null) ??
                    '[brak odpowiedzi]';

                add('assistant', reply);
            } catch (e) {
                add('assistant', '[błąd połączenia z API]');
            }
        }

        async function sendStl(file) {
            if (!file) return;

            ensureSessionId();
            add('user', `Wgrywam STL: ${file.name}`);

            const fd = new FormData();
            fd.append('model', file, file.name);
            fd.append('sessionId', sessionId);

            try {
                const r = await fetch('/api/quote-from-stl', { method: 'POST', body: fd });
                const data = await r.json().catch(() => ({}));

                const q = data?.quote ?? data?.data?.quote ?? data?.output?.quote ?? null;
                if (!q) {
                    add('assistant', '[brak danych wyceny]');
                    return;
                }
                add('assistant', formatQuote(q));
            } catch (e) {
                add('assistant', '[błąd wyceny STL]');
            }
        }

        sendEl.addEventListener('click', sendMessage);
        msgEl.addEventListener('keydown', (e) => { if (e.key === 'Enter') sendMessage(); });

        stlBtn.addEventListener('click', () => stlInp.click());
        stlInp.addEventListener('change', () => {
            const f = stlInp.files && stlInp.files[0];
            stlInp.value = '';
            if (f) sendStl(f);
        });

        newChat.addEventListener('click', () => {
            sessionId = null;
            messages.length = 0;
            render();
            msgEl.focus();
        });

        render();
    </script>
</body>

</html>